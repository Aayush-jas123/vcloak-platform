<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Management - vcloak Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/components.css">
    <style>
        body {
            background: var(--bg-secondary);
        }

        .dashboard-header {
            background: white;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .dashboard-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-left {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .logo {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            font-weight: 600;
            color: var(--text-secondary);
            transition: color var(--transition-fast);
        }

        .nav-links a.active {
            color: var(--primary);
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .provider-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .provider-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .provider-info h3 {
            margin-bottom: 0.5rem;
        }

        .provider-meta {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .locations-list {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .location-item {
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <div class="nav-left">
                    <a href="../index.html" class="logo">vcloak</a>
                    <div class="nav-links">
                        <a href="dashboard.html">Dashboard</a>
                        <a href="providers.html" class="active">Providers</a>
                        <a href="users.html">Users</a>
                        <a href="bookings.html">Bookings</a>
                    </div>
                </div>
                <div>
                    <button id="logout-btn" class="btn btn-ghost btn-sm">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Provider Management</h2>
                <p class="card-subtitle">Manage and verify storage providers</p>
            </div>

            <div class="filters">
                <button class="btn btn-sm" id="filter-all">All</button>
                <button class="btn btn-sm btn-outline" id="filter-verified">Verified</button>
                <button class="btn btn-sm btn-outline" id="filter-unverified">Unverified</button>
            </div>

            <div id="providers-container">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading providers...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="../js/api.js"></script>
    <script src="../js/dashboard-utils.js"></script>
    <script>
        if (!requireAuth() || !requireRole('admin')) {
            // Redirected
        }

        let allProviders = [];
        let currentFilter = 'all';

        async function loadProviders() {
            try {
                showLoading('providers-container');

                const { providers } = await api.getProviders();
                allProviders = providers;

                hideLoading('providers-container');
                renderProviders(allProviders);

            } catch (error) {
                console.error('Error loading providers:', error);
                hideLoading('providers-container');
                document.getElementById('providers-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <p>Failed to load providers. Please try again later.</p>
                    </div>
                `;
                handleApiError(error);
            }
        }

        function renderProviders(providers) {
            const container = document.getElementById('providers-container');

            if (providers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë•</div>
                        <p>No providers found.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = providers.map(provider => `
                <div class="provider-card">
                    <div class="provider-header">
                        <div class="provider-info">
                            <h3>${provider.name}</h3>
                            <div class="provider-meta">
                                üìß ${provider.email}<br>
                                üì± ${provider.phone || 'No phone'}<br>
                                üìÖ Joined ${formatDate(provider.created_at)}
                            </div>
                        </div>
                        <div class="actions">
                            ${getStatusBadge(provider.verified ? 'verified' : 'unverified')}
                            ${!provider.verified ? `
                                <button class="btn btn-sm btn-primary" onclick="verifyProvider(${provider.id})">
                                    Verify Provider
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    ${provider.locations && provider.locations.length > 0 ? `
                        <div class="locations-list">
                            <strong>Locations (${provider.locations.length}):</strong>
                            ${provider.locations.map(loc => `
                                <div class="location-item">
                                    <div>
                                        <strong>${loc.business_name}</strong><br>
                                        <small>${loc.address}</small>
                                    </div>
                                    <div class="actions">
                                        ${getStatusBadge(loc.verified ? 'verified' : 'pending')}
                                        ${!loc.verified ? `
                                            <button class="btn btn-sm btn-secondary" onclick="verifyLocation(${loc.id})">
                                                Verify
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: var(--text-secondary); margin-top: 1rem;">No locations yet</p>'}
                </div>
            `).join('');
        }

        async function verifyProvider(providerId) {
            try {
                await api.verifyProvider(providerId, true);
                showToast('Provider and all locations verified successfully!', 'success');
                loadProviders();
            } catch (error) {
                console.error('Error verifying provider:', error);
                handleApiError(error);
            }
        }

        async function verifyLocation(locationId) {
            try {
                await api.verifyLocation(locationId);
                showToast('Location verified successfully!', 'success');
                loadProviders();
            } catch (error) {
                console.error('Error verifying location:', error);
                handleApiError(error);
            }
        }

        function filterProviders(filter) {
            currentFilter = filter;

            // Update button states
            document.querySelectorAll('.filters button').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });

            const activeBtn = document.getElementById(`filter-${filter}`);
            activeBtn.classList.remove('btn-outline');
            activeBtn.classList.add('btn-primary');

            // Filter providers
            let filtered = allProviders;
            if (filter === 'verified') {
                filtered = allProviders.filter(p => p.verified);
            } else if (filter === 'unverified') {
                filtered = allProviders.filter(p => !p.verified);
            }

            renderProviders(filtered);
        }

        // Event listeners
        document.getElementById('filter-all').addEventListener('click', () => filterProviders('all'));
        document.getElementById('filter-verified').addEventListener('click', () => filterProviders('verified'));
        document.getElementById('filter-unverified').addEventListener('click', () => filterProviders('unverified'));

        document.getElementById('logout-btn').addEventListener('click', () => api.logout());

        loadProviders();
    </script>
</body>

</html>