<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Details - vcloak</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        body {
            background: var(--bg-secondary);
        }

        .hero-section {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
        }

        .hero-content {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 2rem;
        }

        .hero-info h1 {
            color: white;
            margin-bottom: 0.5rem;
        }

        .hero-meta {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .location-image {
            width: 100%;
            height: 300px;
            background: linear-gradient(135deg, var(--secondary-light), var(--primary-light));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            margin-bottom: 2rem;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .info-section {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
        }

        .info-section h3 {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .amenity-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .price-card {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-lg);
            border: 2px solid var(--primary);
            position: sticky;
            top: 2rem;
        }

        .price-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .review-card {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .reviewer-name {
            font-weight: 600;
        }

        .review-rating {
            color: #f59e0b;
        }

        .review-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .details-grid {
                grid-template-columns: 1fr;
            }

            .price-card {
                position: static;
            }
        }
    </style>
</head>

<body>
    <div class="hero-section">
        <div class="container">
            <div class="hero-content">
                <div class="hero-info">
                    <h1 id="location-name">Loading...</h1>
                    <p id="location-address" style="opacity: 0.9; margin-bottom: 1rem;">üìç </p>
                    <div class="hero-meta" id="location-meta">
                        <!-- Badges will be inserted here -->
                    </div>
                </div>
                <div id="action-buttons">
                    <!-- Action buttons will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="location-image" id="location-image">
            üì¶
        </div>

        <div class="details-grid">
            <div>
                <div class="info-section">
                    <h3>About This Location</h3>
                    <p id="location-description">No description available.</p>
                </div>

                <div class="info-section">
                    <h3>Amenities</h3>
                    <div class="amenities-grid" id="amenities-container">
                        <div class="empty-state">
                            <p>No amenities listed</p>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Reviews & Ratings</h3>
                    <div id="reviews-container">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <p>Loading reviews...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="price-card">
                    <div class="price-amount" id="price-display">‚Çπ0/hr</div>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">per bag per hour</p>

                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Capacity:</span>
                            <strong id="capacity-display">0 bags</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Rating:</span>
                            <strong id="rating-display">‚≠ê N/A</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Reviews:</span>
                            <strong id="reviews-count">0</strong>
                        </div>
                    </div>

                    <div id="booking-action">
                        <!-- Booking button will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="js/api.js"></script>
    <script src="js/dashboard-utils.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const locationId = urlParams.get('id');

        if (!locationId) {
            window.location.href = 'index.html';
        }

        let currentLocation = null;
        let currentUser = null;

        // Check if user is logged in
        const token = localStorage.getItem('token');
        if (token) {
            currentUser = getCurrentUser();
        }

        async function loadLocationDetails() {
            try {
                const { location } = await api.getLocation(locationId);
                currentLocation = location;

                // Update hero section
                document.getElementById('location-name').textContent = location.business_name;
                document.getElementById('location-address').textContent = 'üìç ' + location.address;

                // Add badges
                const metaContainer = document.getElementById('location-meta');
                metaContainer.innerHTML = `
                    ${getStatusBadge(location.active ? 'active' : 'inactive')}
                    ${location.verified ? getStatusBadge('verified') : '<span class="badge badge-warning">Unverified</span>'}
                `;

                // Update description
                document.getElementById('location-description').textContent =
                    location.description || 'No description available for this location.';

                // Update amenities
                const amenitiesContainer = document.getElementById('amenities-container');
                const amenities = typeof location.amenities === 'string'
                    ? JSON.parse(location.amenities)
                    : (location.amenities || []);

                if (amenities.length > 0) {
                    amenitiesContainer.innerHTML = amenities.map(amenity => {
                        const icons = {
                            'CCTV': 'üìπ',
                            'WiFi': 'üì∂',
                            '24/7': 'üïê',
                            'Climate Control': '‚ùÑÔ∏è',
                            'Security Guard': 'üëÆ',
                            'Insurance': 'üõ°Ô∏è'
                        };
                        return `
                            <div class="amenity-item">
                                <span>${icons[amenity] || '‚úì'}</span>
                                <span>${amenity}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    amenitiesContainer.innerHTML = '<p style="color: var(--text-secondary);">No amenities listed</p>';
                }

                // Update price card
                document.getElementById('price-display').textContent = formatCurrency(location.price_per_hour) + '/hr';
                document.getElementById('capacity-display').textContent = location.capacity + ' bags';
                document.getElementById('rating-display').textContent = '‚≠ê ' + (location.rating || 'N/A');
                document.getElementById('reviews-count').textContent = location.total_reviews || 0;

                // Set action buttons based on user role
                setActionButtons(location);

                // Load reviews
                loadReviews();

            } catch (error) {
                console.error('Error loading location:', error);
                handleApiError(error);
                document.getElementById('location-name').textContent = 'Error loading location';
            }
        }

        function setActionButtons(location) {
            const actionButtonsContainer = document.getElementById('action-buttons');
            const bookingActionContainer = document.getElementById('booking-action');

            if (!currentUser) {
                // Not logged in - show login prompt
                bookingActionContainer.innerHTML = `
                    <a href="login.html" class="btn btn-primary" style="width: 100%;">Login to Book</a>
                `;
                return;
            }

            if (currentUser.role === 'provider' && location.provider_id === currentUser.id) {
                // Owner - show edit button
                actionButtonsContainer.innerHTML = `
                    <a href="provider/location-form.html?id=${location.id}" class="btn btn-secondary">
                        ‚úèÔ∏è Edit Location
                    </a>
                `;
                bookingActionContainer.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center;">This is your location</p>
                `;
            } else if (currentUser.role === 'traveler') {
                // Traveler - show book button
                bookingActionContainer.innerHTML = `
                    <a href="traveler/booking-form.html?location=${location.id}" class="btn btn-primary" style="width: 100%;">
                        üìÖ Book Now
                    </a>
                `;
            } else {
                bookingActionContainer.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center;">Booking not available</p>
                `;
            }
        }

        async function loadReviews() {
            try {
                const { reviews } = await api.getLocationReviews(locationId);
                const container = document.getElementById('reviews-container');

                if (reviews.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üí¨</div>
                            <p>No reviews yet. Be the first to review!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = reviews.map(review => `
                    <div class="review-card">
                        <div class="review-header">
                            <div>
                                <div class="reviewer-name">${review.traveler?.name || 'Anonymous'}</div>
                                <div class="review-date">${formatDate(review.created_at)}</div>
                            </div>
                            <div class="review-rating">${'‚≠ê'.repeat(review.rating)}</div>
                        </div>
                        <p>${review.comment}</p>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading reviews:', error);
                document.getElementById('reviews-container').innerHTML = `
                    <p style="color: var(--text-secondary);">Unable to load reviews</p>
                `;
            }
        }

        loadLocationDetails();
    </script>
</body>

</html>